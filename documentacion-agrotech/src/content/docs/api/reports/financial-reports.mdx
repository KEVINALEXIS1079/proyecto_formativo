---
title: Reportes Financieros Avanzados
description: An√°lisis financiero completo de ventas, costos y rentabilidad
---

import { Tabs, TabItem, Code } from '@astrojs/starlight/components';

## GET /reports/financial/sales

Reporte detallado de ventas con filtros avanzados.

### Par√°metros de Query

```typescript
interface SalesReportQuery {
  from?: string;          // Fecha inicio (YYYY-MM-DD)
  to?: string;            // Fecha fin (YYYY-MM-DD)
  clienteId?: string;     // ID del cliente
  productoAgroId?: string; // ID del producto
  cultivoId?: string;     // ID del cultivo origen
}
```

### Respuesta Compleja

```typescript
interface SalesReport {
  resumen: {
    totalVentas: number;
    totalIngresos: number;
    totalClientes: number;
    productosVendidos: number;
    ticketPromedio: number;
    periodo: {
      inicio: Date;
      fin: Date;
      dias: number;
    };
  };
  ventasPorPeriodo: Array<{
    periodo: string;      // YYYY-MM-DD
    ventas: number;
    ingresos: number;
    clientes: number;
    productos: number;
  }>;
  topProductos: Array<{
    producto: string;
    cantidadVendida: number;
    ingresosTotales: number;
    precioPromedio: number;
    margenPromedio: number;
  }>;
  topClientes: Array<{
    cliente: string;
    totalCompras: number;
    frecuenciaCompras: number;
    ticketPromedio: number;
    ultimoCompra: Date;
  }>;
  metodosPago: Array<{
    metodo: string;
    cantidad: number;
    porcentaje: number;
    montoTotal: number;
  }>;
}
```

## GET /reports/financial/prices

An√°lisis hist√≥rico de precios por producto.

### Par√°metros de Query

```typescript
interface HistoricalPricesQuery {
  productoAgroId: number; // Obligatorio
  from?: string;          // Fecha inicio
  to?: string;            // Fecha fin
  cultivoId?: string;     // Filtrar por cultivo origen
}
```

### Respuesta

```typescript
interface HistoricalPricesReport {
  producto: {
    id: number;
    nombre: string;
    unidadMedida: string;
  };
  estadisticasGenerales: {
    precioMinimo: number;
    precioMaximo: number;
    precioPromedio: number;
    desviacionEstandar: number;
    totalTransacciones: number;
  };
  preciosPorPeriodo: Array<{
    periodo: string;      // YYYY-MM
    precioMinimo: number;
    precioMaximo: number;
    precioPromedio: number;
    volumenTotal: number;
    transacciones: number;
  }>;
  tendencias: {
    direccion: 'ASCENDENTE' | 'DESCENDENTE' | 'ESTABLE';
    cambioPorcentual: number;
    volatilidad: 'BAJA' | 'MEDIA' | 'ALTA';
  };
}
```

## GET /reports/financial/rentability/:cultivoId

An√°lisis completo de rentabilidad de un cultivo.

### Respuesta Detallada

```typescript
interface CropRentabilityReport {
  cultivo: {
    id: number;
    nombreCultivo: string;
    lote?: {
      nombre: string;
    };
    areaTotal: number;
  };
  periodoAnalisis: {
    inicio: Date;
    fin: Date;
  };
  costos: {
    totalCostos: number;
    costoPorHectarea: number;
    desglose: {
      insumos: number;
      manoObra: number;
      servicios: number;
      otros: number;
    };
    costoPorTipoActividad: Array<{
      tipoActividad: string;
      costoTotal: number;
      porcentaje: number;
    }>;
  };
  ingresos: {
    totalIngresos: number;
    ingresoPorHectarea: number;
    productosVendidos: Array<{
      producto: string;
      cantidad: number;
      precioPromedio: number;
      ingresos: number;
    }>;
  };
  rentabilidad: {
    utilidadBruta: number;
    utilidadNeta: number;
    margenBruto: number;        // porcentaje
    margenNeto: number;         // porcentaje
    roi: number;                // Retorno de inversi√≥n
    paybackPeriod?: number;     // meses
  };
  indicadores: {
    productividad: number;      // kg/ha
    eficienciaCosto: number;    // $/kg
    rentabilidadHectarea: number; // $/ha
  };
}
```

## GET /reports/financial/rentability/lote/:loteId

An√°lisis de rentabilidad por lote espec√≠fico.

### Respuesta

Similar a `CropRentabilityReport` pero enfocado en un lote espec√≠fico con:
- Costos espec√≠ficos del lote
- Ingresos de productos del lote
- Comparaci√≥n con otros lotes similares

## GET /reports/financial/rentability/sublote/:subLoteId

An√°lisis granular por sub-lote.

### Respuesta

An√°lisis m√°s detallado incluyendo:
- Variaciones microclim√°ticas
- Eficiencia por zonas
- Optimizaciones espec√≠ficas

## GET /reports/financial/crop-summary/:cultivoId

Resumen ejecutivo de cultivo con m√©tricas clave.

### Respuesta

```typescript
interface CropSummary {
  cultivo: {
    id: number;
    nombreCultivo: string;
    estado: string;
    progreso: number; // 0-100
  };
  metricasPrincipales: {
    areaCultivada: number;
    costoTotal: number;
    costoPorHectarea: number;
    rendimientoEsperado: number;
    rendimientoActual: number;
    ingresosEstimados: number;
    utilidadEstimada: number;
  };
  rendimiento: {
    actual: number;
    esperado: number;
    porcentajeCumplimiento: number;
    tendencia: 'MEJORANDO' | 'ESTABLE' | 'EMPEORANDO';
  };
  eficiencia: {
    costoInsumo: number;     // $/kg
    costoManoObra: number;   // $/ha
    costoTotal: number;      // $/ha
    benchmark: {             // comparaci√≥n con promedio del sector
      costoInsumo: number;
      costoManoObra: number;
      rendimiento: number;
    };
  };
}
```

## GET /reports/financial/export

Exporta reportes financieros a Excel/CSV.

### Par√°metros de Query

- `from`: Fecha inicio
- `to`: Fecha fin
- `clienteId`: ID del cliente
- `productoAgroId`: ID del producto
- `cultivoId`: ID del cultivo
- `format`: `csv` | `xlsx` (default: `xlsx`)

### Estructura del Excel Exportado

```
üìä Reportes Financieros
‚îú‚îÄ‚îÄ üìà Resumen Ejecutivo
‚îú‚îÄ‚îÄ üí∞ Ventas Detalladas
‚îú‚îÄ‚îÄ üì¶ Productos M√°s Vendidos
‚îú‚îÄ‚îÄ üë• Top Clientes
‚îú‚îÄ‚îÄ üí≥ M√©todos de Pago
‚îú‚îÄ‚îÄ üìä An√°lisis por Per√≠odo
‚îî‚îÄ‚îÄ üìã Detalle de Transacciones
```

## Ejemplos de An√°lisis Financiero

### An√°lisis de Rentabilidad

```javascript
// Obtener rentabilidad de cultivo
const rentabilidad = await fetch('/reports/financial/rentability/1')
  .then(r => r.json());

// Calcular indicadores clave
const roi = rentabilidad.rentabilidad.roi;
const margenNeto = rentabilidad.rentabilidad.margenNeto;

console.log(`ROI: ${roi.toFixed(2)}%`);
console.log(`Margen Neto: ${margenNeto.toFixed(2)}%`);

// Evaluar viabilidad
if (roi > 15 && margenNeto > 10) {
  console.log('‚úÖ Cultivo rentable');
} else if (roi > 5) {
  console.log('‚ö†Ô∏è Cultivo marginal');
} else {
  console.log('‚ùå Cultivo no rentable');
}
```

### Seguimiento de Precios

```javascript
// Analizar evoluci√≥n de precios
const precios = await fetch('/reports/financial/prices?productoAgroId=1&from=2025-01-01')
  .then(r => r.json());

// Detectar tendencias
const tendencia = precios.tendencias.direccion;
const cambio = precios.tendencias.cambioPorcentual;

if (tendencia === 'ASCENDENTE' && cambio > 10) {
  console.log('üìà Precios aumentando significativamente');
} else if (tendencia === 'DESCENDENTE') {
  console.log('üìâ Precios disminuyendo');
}
```

### Benchmarking de Costos

```javascript
// Comparar con est√°ndares del sector
const summary = await fetch('/reports/financial/crop-summary/1')
  .then(r => r.json());

const eficiencia = summary.eficiencia;
const benchmark = eficiencia.benchmark;

// Comparar costos
const costoInsumoVsBenchmark = (eficiencia.costoInsumo / benchmark.costoInsumo - 1) * 100;

if (costoInsumoVsBenchmark < -10) {
  console.log('üí∞ Costos de insumos por debajo del promedio');
} else if (costoInsumoVsBenchmark > 10) {
  console.log('‚ö†Ô∏è Costos de insumos por encima del promedio');
}
```

## Indicadores Financieros Avanzados

### ROI (Retorno de Inversi√≥n)
```
ROI = (Utilidad Neta / Inversi√≥n Total) √ó 100
```

### Margen Bruto
```
Margen Bruto = (Ingresos - Costos Variables) / Ingresos √ó 100
```

### Margen Neto
```
Margen Neto = Utilidad Neta / Ingresos √ó 100
```

### Payback Period
```
Payback = Inversi√≥n Total / Flujo de Caja Anual
```

### EVA (Economic Value Added)
```
EVA = Utilidad Neta - (Capital Invertido √ó Costo de Capital)
```

## An√°lisis de Tendencias

### An√°lisis de Series Temporales
- **Tendencia**: Direcci√≥n general (ascendente/descendente)
- **Estacionalidad**: Patrones recurrentes
- **Ciclicidad**: Ciclos econ√≥micos largos
- **Componente Irregular**: Variaciones aleatorias

### Predicci√≥n de Precios
- **Modelos ARIMA**: Para series temporales
- **An√°lisis de Regresi√≥n**: Correlaci√≥n con variables externas
- **Machine Learning**: Modelos predictivos avanzados

## Optimizaci√≥n Financiera

### Estrategias de Precio
1. **Precio Premium**: Para productos de calidad superior
2. **Precio Din√°mico**: Basado en oferta/demanda
3. **Descuentos por Volumen**: Incentivar compras grandes
4. **Precios Psicol√≥gicos**: Estrategias de marketing

### Gesti√≥n de Costos
1. **An√°lisis ABC**: Clasificar costos por importancia
2. **Costeo por Actividad**: Asignar costos precisos
3. **Benchmarking**: Comparar con mejores pr√°cticas
4. **Optimizaci√≥n de Insumos**: Reducir desperdicios

### Mejora de Rentabilidad
1. **Aumento de Productividad**: M√°s producci√≥n por unidad
2. **Reducci√≥n de Costos**: Eficiencia operativa
3. **Mejora de Calidad**: Precios premium
4. **Diversificaci√≥n**: Nuevos productos/markets

## Alertas Financieras

### Umbrales de Rentabilidad
- **ROI < 5%**: Alerta cr√≠tica
- **ROI 5-10%**: Alerta moderada
- **ROI 10-15%**: Rentable
- **ROI > 15%**: Muy rentable

### L√≠mites de Costo
- **Costo > 80% de ingresos**: Problema cr√≠tico
- **Costo 70-80% de ingresos**: Requiere atenci√≥n
- **Costo < 70% de ingresos**: Saludable

## Integraci√≥n con Otros M√≥dulos

### Con Producci√≥n
- Costos de producci√≥n por lote
- An√°lisis de precios de venta
- Rentabilidad por producto

### Con Inventario
- Costos de insumos por cultivo
- Rotaci√≥n de inventario
- Valor del inventario

### Con Actividades
- Costos por tipo de actividad
- Eficiencia de mano de obra
- ROI por actividad

## C√≥digos de Error

| C√≥digo | Descripci√≥n |
|--------|-------------|
| `400` | Par√°metros de fecha inv√°lidos |
| `403` | Sin permisos para reportes financieros |
| `404` | Cultivo/cliente/producto no encontrado |
| `422` | Datos insuficientes para an√°lisis |
| `500` | Error en c√°lculos financieros |

## Configuraci√≥n Avanzada

### Reglas de Costeo
```typescript
interface CostingRules {
  metodoCosteo: 'FIFO' | 'LIFO' | 'PROMEDIO';
  incluirDepreciacion: boolean;
  costoFinanciero: number; // porcentaje
  moneda: string;
  inflacion: number; // porcentaje anual
}
```

### Escenarios de An√°lisis
```typescript
interface AnalysisScenario {
  nombre: string;
  variables: {
    precioVenta: number;
    costoInsumos: number;
    rendimiento: number;
  };
  resultado: {
    utilidad: number;
    roi: number;
    payback: number;
  };
}
```

:::note[Actualizaci√≥n Autom√°tica]
Los reportes financieros se actualizan autom√°ticamente con cada venta registrada.
:::

:::tip[An√°lisis Comparativo]
Compara rentabilidad entre cultivos para optimizar la rotaci√≥n y diversificaci√≥n.
:::

:::warning[Validaci√≥n de Datos]
Aseg√∫rate de que todos los costos est√©n correctamente registrados para an√°lisis precisos.
:::