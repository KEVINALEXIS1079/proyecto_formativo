MÃ“DULO 1 Â· AutenticaciÃ³n & Permisos
RF01 â€“ Registro de usuario
Tipo: Funcional
 PropÃ³sito: Crear usuarios asegurando unicidad y asignando rol Invitado por defecto.
DescripciÃ³n detallada:
â—	El sistema debe permitir que cualquier persona se registre con sus datos personales y de contacto.

â—	Se valida que identificaciÃ³n y correo no estÃ©n registrados previamente.

â—	La contraseÃ±a se encripta con bcrypt antes de guardarla.

â—	El usuario se crea con:

â—‹	estado inicial (ej. pendiente_verificacion o activo segÃºn polÃ­tica).

â—‹	rolId apuntando al rol base Invitado.

â—	Los roles fijos del sistema deben existir como semilla: Administrador, Instructor, Aprendiz, Pasante, Invitado.

â—	El cambio de rol (de Invitado a otro) solo se hace desde gestiÃ³n de roles (no desde el registro).

Datos principales:
â—	Entrada: nombre, apellido, identificacion, idFicha, telefono, correo, password.

â—	Interno: creaciÃ³n de Usuario + asignaciÃ³n de rolId = rol.invitado.

â—	Salida: usuario creado (sin password) + posible trigger de envÃ­o de correo de verificaciÃ³n.

________________________________________
RF02 â€“ VerificaciÃ³n de correo
Tipo: Funcional
 PropÃ³sito: Confirmar que el email del usuario es vÃ¡lido.
DescripciÃ³n detallada:
â—	Al registrarse o al pedir â€œreenviar cÃ³digoâ€, se genera un EmailCode de tipo verify con 6 dÃ­gitos.

â—	El cÃ³digo tiene una fecha de expiraciÃ³n (ej. 10â€“30 min).

â—	Solo se considera vÃ¡lido si:

â—‹	Coincide el cÃ³digo.

â—‹	expiresAt > now.

â—‹	usedAt es null.

â—	Al validar correctamente:

â—‹	Se llena Usuario.emailVerifiedAt con now.

â—‹	Se marca EmailCode.usedAt = now.

â—‹	Opcional: invalidar cÃ³digos anteriores no usados de tipo verify para ese usuario.

Datos principales:
â—	EmailCode{userId, tipo="verify", code, expiresAt, usedAt}

â—	Usuario.emailVerifiedAt

________________________________________
RF03 â€“ Login con cookies seguras
Tipo: Funcional
 PropÃ³sito: Autenticar y crear sesiÃ³n basada en cookies HttpOnly.
DescripciÃ³n detallada:
â—	El usuario envÃ­a correo y password.

â—	Se verifica:

â—‹	Que el usuario exista.

â—‹	Que no estÃ© en estado inactivo o eliminado.

â—‹	ContraseÃ±a correcta (bcrypt.compare).

â—	Si todo ok:

â—‹	Se genera un token de sesiÃ³n (ej. ID almacenado en Redis o JWT con id de sesiÃ³n).

â—‹	Se responde con cookie:

â– 	auth_token = token

â– 	HttpOnly = true

â– 	Secure = true (en producciÃ³n HTTPS)

â– 	SameSite = Lax o Strict.

â—‹	Se actualiza lastLoginAt.

â—	Si las credenciales fallan, devolver error genÃ©rico (no indicar si el correo existe).

Datos principales:
â—	Entrada: correo, password.

â—	Salida: cookie auth_token + usuario bÃ¡sico.

â—	Persistencia: tabla/sesiÃ³n en Redis con sessionId â†’ userId, expiresAt.

________________________________________
RF04 â€“ Logout
Tipo: Funcional
 PropÃ³sito: Cerrar sesiÃ³n del usuario.
DescripciÃ³n detallada:
â—	El frontend llama al endpoint de logout mientras la cookie auth_token estÃ¡ presente.

â—	El backend:

â—‹	Elimina o marca como invÃ¡lida la sesiÃ³n asociada al token (en Redis o DB).

â—‹	Responde una cookie auth_token vacÃ­a o expirada (Max-Age=0).

â—	Si la sesiÃ³n ya no existe, el logout es igualmente exitoso (idempotente).

Datos principales:
â—	Entrada: cookie auth_token.

â—	Interno: borrar/inutilizar sessionId.

________________________________________
RF05 â€“ RecuperaciÃ³n de contraseÃ±a
Tipo: Funcional
 PropÃ³sito: Restablecer contraseÃ±a mediante cÃ³digo enviado al correo.
DescripciÃ³n detallada:
â—	Paso 1: el usuario ingresa su correo en â€œolvidÃ© mi contraseÃ±aâ€.

â—	Si el correo existe, se genera un EmailCode tipo reset con 6 dÃ­gitos y expiraciÃ³n.

â—	Paso 2: el usuario ingresa correo, code y nuevaContraseÃ±a.

â—	Validaciones:

â—‹	CÃ³digo existe para ese userId.

â—‹	tipo = reset.

â—‹	No expirado.

â—‹	usedAt es null.

â—	Si es vÃ¡lido:

â—‹	Se recalcula passwordHash y se guarda.

â—‹	Se marca usedAt = now.

â—‹	Opcional: invalidar todas las sesiones activas del usuario.

________________________________________
RF06 â€“ GestiÃ³n de roles
Tipo: Funcional
 PropÃ³sito: Administrar roles del sistema y asignarlos a usuarios.
DescripciÃ³n detallada:
â—	CRUD de roles con restricciÃ³n de no poder borrar roles marcados como esSistema.

â—	Roles base: Administrador, Instructor, Aprendiz, Pasante, Invitado deben venir precargados.

â—	Un rol puede activarse/desactivarse (estado), y si estÃ¡ inactivo no debe asignarse a nuevos usuarios.

â—	Desde este mÃ³dulo, un admin puede cambiar el rol principal de un usuario.

â—	Al cambiar de rol se debe disparar la invalidaciÃ³n de cachÃ© de permisos efectivos del usuario.

________________________________________
RF07 â€“ GestiÃ³n de permisos
Tipo: Funcional
 PropÃ³sito: Definir permisos granulares y asignarlos a roles/usuarios.
DescripciÃ³n detallada:
â—	Permiso = combinaciÃ³n (modulo, accion, clave). Ejemplo:

â—‹	modulo = "usuarios", accion = "ver", clave = "usuarios.ver".

â—	CRUD de permisos (normalmente hecho por Admin).

â—	RelaciÃ³n muchos a muchos:

â—‹	RolPermiso (rol hereda permisos).

â—‹	UsuarioPermiso (excepciones o permisos extra).

â—	Al agregar/quitar permisos a roles o usuarios, invalidar cachÃ© de permisos efectivos de los usuarios afectados.

________________________________________
RF08 â€“ Permisos efectivos y cachÃ©
Tipo: Funcional
 PropÃ³sito: Optimizar autorizaciÃ³n calculando y cacheando permisos efectivos por usuario.
DescripciÃ³n detallada:
â—	Al autenticar o al verificar permisos:

â—‹	Buscar en Redis permisos:user:{userId}.

â—‹	Si existe â†’ usar lista de claves (ej: "usuarios.ver").

â—‹	Si no existe â†’ calcular:

â– 	Permisos de su rol (RolPermiso).

â– 	Permisos directos (UsuarioPermiso).

â– 	UniÃ³n (sin duplicados) â†’ permisosEfectivos.

â– 	Guardar en cachÃ© (con TTL opcional).

â—	Al modificar rol o permisos asociados:

â—‹	Borrar o refrescar clave de cachÃ© de los usuarios impactados.

â—	Middleware de autorizaciÃ³n:

â—‹	Verifica si la clave requerida estÃ¡ en permisosEfectivos.

________________________________________
MÃ“DULO 2 Â· Geo: Lotes & SubLotes
RF09 â€“ Registro de lotes
Tipo: Funcional
 PropÃ³sito: Modelar Ã¡reas principales de terreno.
DescripciÃ³n detallada:
â—	Un lote es un polÃ­gono cerrado, almacenado como geom (GeoJSON / PostGIS).

â—	Al guardar/editar geom:

â—‹	Calcular areaM2 usando funciones espaciales.

â—‹	Convertir areaHa = areaM2 / 10 000.

â—‹	Calcular centroide.

â—	Validaciones geomÃ©tricas:

â—‹	PolÃ­gono simple (sin autointersecciones).

â—‹	SRID consistente (ej: EPSG:4326).

â—	Se debe permitir desactivar un lote (estado = inactivo) si ya no se usa.

________________________________________
RF10 â€“ Registro de sublotes
Tipo: Funcional
 PropÃ³sito: Subdividir un lote en secciones mÃ¡s pequeÃ±as.
DescripciÃ³n detallada:
â—	Cada sublote se asocia a un loteId.

â—	Al guardar/editar SubLote.geom:

â—‹	Validar que ST_Contains(Lote.geom, SubLote.geom) sea true.

â—‹	Validar que no haya solape con otros sublotes de ese mismo lote (ST_Overlaps = false).

â—	Mismas operaciones de cÃ¡lculo: areaM2, areaHa, centroide.

â—	Nombre Ãºnico por lote (ej. no tener 2 sublotes â€œA1â€ dentro del mismo lote).

________________________________________
RF11 â€“ Validaciones geoespaciales
Tipo: Funcional
 PropÃ³sito: Garantizar integridad espacial de lotes y sublotes.
DescripciÃ³n detallada:
â—	Implementar Ã­ndices espaciales (GiST/SP-GiST) sobre columnas geom de Lote y SubLote.

â—	Antes de confirmar creaciÃ³n/ediciÃ³n de geometrÃ­a:

â—‹	Verificar contenciÃ³n subloteâ€“lote.

â—‹	Verificar no solapamiento entre sublotes del mismo lote.

â—	Opcional: reglas para que lotes tampoco se solapen entre sÃ­ (segÃºn necesidad del proyecto).

________________________________________
MÃ“DULO 3 Â· Cultivos
RF12 â€“ Crear cultivo
Tipo: Funcional
 PropÃ³sito: Registrar un cultivo asociado a una ubicaciÃ³n (Lote o SubLote).
DescripciÃ³n detallada:
â—	Un cultivo debe estar asociado a exactamente uno:

â—‹	loteId o subLoteId (XOR).

â—	Se guarda info bÃ¡sica: tipoCultivo, nombreCultivo, descripcion.

â—	fechaCreacion = timestamp del sistema al crear.

â—	estado inicial = "activo" (o "en_proceso").

â—	No se debe permitir que haya dos cultivos â€œactivosâ€ en el mismo Lote/SubLote si esto es una regla del negocio (opcional, tÃº decides).

________________________________________
RF13 â€“ Fechas clave por actividades
Tipo: Funcional
 PropÃ³sito: Sincronizar fechas clave del cultivo segÃºn actividades.
DescripciÃ³n detallada:
â—	Cuando se registra la primera actividad de subtipo = SIEMBRA para un cultivo:

â—‹	Si Cultivo.fechaSiembra es null â†’ setearla con fecha de la actividad.

â—	Cuando se registra una actividad de subtipo = FINALIZACION:

â—‹	Setear Cultivo.fechaFinalizacion = fecha.

â—‹	Setear Cultivo.estado = "finalizado".

â—	Opcional: restringir actividades posteriores si el cultivo estÃ¡ finalizado.

________________________________________
RF14 â€“ Listado y filtros de cultivos
Tipo: Funcional
 PropÃ³sito: Encontrar cultivos de forma Ã¡gil.
DescripciÃ³n detallada:
â—	Filtro de texto q:

â—‹	Debe buscar por nombreCultivo, tipoCultivo y/o descripcion (LIKE/ILIKE).

â—	Filtros especÃ­ficos:

â—‹	Por tipoCultivo.

â—‹	Por loteId o subLoteId.

â—‹	Por estado.

â—	PaginaciÃ³n estÃ¡ndar:

â—‹	page, pageSize, total.

â—	Opcional: ordenamiento por fechaCreacion, nombreCultivo, etc.

________________________________________
MÃ“DULO 4 Â· Actividades
RF15 â€“ Crear actividad
Tipo: Funcional
 PropÃ³sito: Registrar cualquier acciÃ³n realizada sobre un cultivo.
DescripciÃ³n detallada:
â—	Campos bÃ¡sicos: nombre, tipo, subtipo, fecha, descripcion.

â—	AsociaciÃ³n obligatoria:

â—‹	cultivoId.

â—‹	loteId o subLoteId (XOR), coherente con la ubicaciÃ³n del cultivo.

â—	tipo indica macro-proceso (creaciÃ³n/mantenimiento/finalizaciÃ³n).

â—	subtipo define la acciÃ³n concreta (ej. SIEMBRA, COSECHA, RIEGO, PODA, etc.).

â—	Se pueden usar catÃ¡logos para tipos/subtipos o enums directos.

________________________________________
RF16 â€“ Responsable obligatorio (actor)
Tipo: Funcional
 PropÃ³sito: Garantizar trazabilidad de la persona responsable.
DescripciÃ³n detallada:
â—	Al crear actividad, se registra:

â—‹	Actividad.creadoPorUsuarioId = userLogeado.

â—	En paralelo se crea un registro en ActividadResponsable con ese mismo usuario como responsable base (aunque aÃºn no tenga horas/costo).

â—	En ediciones posteriores se pueden agregar mÃ¡s responsables.

________________________________________
RF17 â€“ Mano de obra
Tipo: Funcional
 PropÃ³sito: Calcular costo de mano de obra a nivel actividad.
DescripciÃ³n detallada:
â—	Campos a nivel actividad:

â—‹	horasActividad (duraciÃ³n total de la actividad).

â—‹	precioHoraActividad (tarifa por hora).

â—	Costo global de MO:

â—‹	costoMO = horasActividad * precioHoraActividad * N_responsables.

â—	Alternativa (si quieres mÃ¡s detalle):

â—‹	ActividadResponsable puede tener sus propias horas/precio/costo.

â—‹	El sistema suma todos esos para obtener costoMO.

________________________________________
RF18 â€“ Servicios en actividad
Tipo: Funcional
 PropÃ³sito: Registrar costos de servicios contratados (maquinaria, asesorÃ­a, etc.).
DescripciÃ³n detallada:
â—	Cada servicio vinculado a una actividad tiene:

â—‹	nombreServicio.

â—‹	horas.

â—‹	precioHora.

â—‹	costo = horas * precioHora.

â—	El costo total de servicios del cultivo se usarÃ¡ en reportes de rentabilidad.

________________________________________
RF19 â€“ Evidencias
Tipo: Funcional
 PropÃ³sito: Dejar constancia visual de lo realizado.
DescripciÃ³n detallada:
â—	Por actividad se pueden guardar una o varias evidencias:

â—‹	descripcion corta.

â—‹	imagenes[]: lista de URLs o rutas en almacenamiento (S3, local, etc.).

â—	No se maneja â€œobservaciÃ³nâ€ extra (como ya me habÃ­as pedido antes), solo descripciÃ³n + imÃ¡genes.

________________________________________
RF20 â€“ Consumo de insumos
Tipo: Funcional
 PropÃ³sito: Conectar actividades con inventario de insumos.
DescripciÃ³n detallada:
â—	Desde la actividad se seleccionan insumos, cantidad usada y costo unitario de uso.

â—	Al guardar:

â—‹	Se descuenta cantidadUso del stockUso del insumo.

â—‹	Se genera un MovimientoInsumo con tipo=CONSUMO.

â—	Validaciones:

â—‹	No permitir que stockUso quede negativo.

â—	El costo total se usa para calcular costo de actividad y luego la rentabilidad.

________________________________________
RF21 â€“ Actividad de siembra
Tipo: Funcional
 PropÃ³sito: Disparar la fecha de siembra del cultivo automÃ¡ticamente.
DescripciÃ³n detallada:
â—	Si se crea una actividad con subtipo = SIEMBRA y el cultivo no tiene fechaSiembra:

â—‹	Setear Cultivo.fechaSiembra = Actividad.fecha.

â—	Si ya tenÃ­a fechaSiembra, se puede:

â—‹	O bloquear nuevas siembras.

â—‹	O permitirlas pero no cambiar la fecha (segÃºn lo que tÃº definas).

________________________________________
RF22 â€“ Actividad de finalizaciÃ³n
Tipo: Funcional
 PropÃ³sito: Marcar el cierre del ciclo del cultivo.
DescripciÃ³n detallada:
â—	Si subtipo = FINALIZACION:

â—‹	Cultivo.fechaFinalizacion = Actividad.fecha.

â—‹	Cultivo.estado = "finalizado".

â—	Opcional: impedir crear nuevas actividades normales sobre cultivos finalizados, excepto algunas especiales (ajustes, reportes, etc.).

________________________________________
RF23 â€“ Actividad de cosecha
Tipo: Funcional
 PropÃ³sito: Conectar la cosecha con producciÃ³n vendible.
DescripciÃ³n detallada:
â—	Con subtipo = COSECHA:

â—‹	Se ingresan kgRecolectados.

â—‹	Se crea un LoteProduccion asociado al cultivo.

â—‹	Se crea un MovimientoProduccion de tipo INGRESO_COSECHA.

â—	Esto genera stock disponible en kg para ventas POS.

________________________________________
MÃ“DULO 5 Â· Inventario de Insumos
RF24 â€“ CRUD de insumos
Tipo: Funcional
 PropÃ³sito: Definir la ficha completa de un insumo.
Detalle clave:
â—	presentacionTipo + presentacionCantidad + presentacionUnidad: ejemplo â€œ1 litroâ€, â€œ500 gâ€.

â—	tipoMateria indica si el insumo es sÃ³lido o lÃ­quido (esto define si la unidad de uso serÃ¡ g o cmÂ³).

â—	factorConversionUso: cuÃ¡ntas unidades de uso hay en una presentaciÃ³n (ej. 1 L = 1000 cmÂ³, 1 kg = 1000 g).

â—	Se calculan y mantienen:

â—‹	stockPresentacion (ej. cuÃ¡ntas botellas).

â—‹	stockUso (cuÃ¡ntos g o cmÂ³ totales).

â—‹	precioUnitarioUso = precioUnitarioPresentacion / factorConversionUso.

â—‹	valorInventario = stockPresentacion * precioUnitarioPresentacion.

________________________________________
RF25 â€“ Historial de movimientos
Tipo: Funcional
 PropÃ³sito: Mantener traza de todo lo que pasÃ³ con cada insumo.
Detalle clave:
â—	Tipos de movimiento:

â—‹	REGISTRO (carga inicial / compra).

â—‹	AJUSTE (correcciÃ³n de stock).

â—‹	CONSUMO (uso en actividades).

â—‹	TRASLADO (entre almacenes).

â—‹	ELIMINACION / RESTAURACION (soft delete + recuperaciÃ³n).

â—	Cada movimiento debe guardar el usuario que lo ejecuta.

â—	deltaPresentacion y deltaUso pueden ser positivos o negativos segÃºn el movimiento.

â—	El sistema recalcula y guarda valorInventarioResultante despuÃ©s del movimiento.

________________________________________
RF26 â€“ ValidaciÃ³n de stock y derivados
Tipo: Funcional
 PropÃ³sito: Evitar inconsistencias en inventario.
Detalle clave:
â—	Antes de aplicar un movimiento:

â—‹	Verificar que stockPresentacion + deltaPresentacion >= 0.

â—‹	Verificar que stockUso + deltaUso >= 0.

â—	Tras cada cambio: recalcular:

â—‹	precioUnitarioUso si cambia base.

â—‹	valorInventario.

â—	En caso de error (stock negativo), rechazar la operaciÃ³n con mensaje claro.

________________________________________
RF27 â€“ CatÃ¡logos de inventario
Tipo: Funcional
 PropÃ³sito: Ordenar los insumos por almacÃ©n, proveedor y categorÃ­a.
Detalle clave:
â—	Almacen: nombre + ubicaciÃ³n fÃ­sica.

â—	Proveedor: solo nombre al inicio (puedes ampliar despuÃ©s).

â—	Categoria: grupos como fertilizantes, herbicidas, fungicidas, etc.

â—	Estos catÃ¡logos se usan en filtros y en la ficha de insumos.
MÃ“DULO 6 Â· Wiki Fitosanitaria (EPA)
RF28 â€“ CRUD de EPA 
Tipo: Funcional
 PropÃ³sito: Gestionar fichas fitosanitarias (Enfermedades, Plagas, Arvences) como una wiki interna.
DescripciÃ³n detallada:
â—	Cada ficha EPA describe un problema fitosanitario asociado a uno o varios cultivos (vÃ­a tipos de cultivo de la wiki).

â—	La ficha incluye descripciÃ³n, sÃ­ntomas, manejo/control, estacionalidad y recursos visuales.

â—	Operaciones:

â—‹	Crear nueva ficha EPA.

â—‹	Editar ficha existente.

â—‹	Consultar ficha (detalle).

â—‹	Listar fichas con filtros (ver RF30).

â—‹	Eliminar lÃ³gica (soft delete): deletedAt â‰  null.

â—	Estacionalidad:

â—‹	mesesProbables[1..12]: array de boolean para cada mes.

â—‹	temporadas[]: texto o catÃ¡logo (ej. â€œlluviasâ€, â€œsecaâ€).

â—‹	notasEstacionalidad: texto libre para observaciones.

â—	ImÃ¡genes:

â—‹	fotosSintomas[]: imÃ¡genes especÃ­ficas de sÃ­ntomas.

â—‹	fotosGenerales[]: contexto o planta completa.

â—	Tags:

â—‹	Lista de palabras clave para bÃºsquedas rÃ¡pidas (tags[]).

â—	Trazabilidad:

â—‹	creadoPorUsuarioId, createdAt, updatedAt, deletedAt.

Datos principales:
â—	EPA

â—‹	id

â—‹	nombre

â—‹	tipoEpa (ENFERMEDAD | PLAGA | ARVENCE)

â—‹	descripcion

â—‹	sintomas

â—‹	manejoYControl

â—‹	mesesProbables (array 1..12)

â—‹	temporadas[]

â—‹	notasEstacionalidad

â—‹	fotosSintomas[] (urls)

â—‹	fotosGenerales[]

â—‹	tags[]

â—‹	creadoPorUsuarioId

â—‹	createdAt, updatedAt, deletedAt

________________________________________
RF29 â€“ Tipos de cultivo (wiki)
Tipo: Funcional
 PropÃ³sito: Clasificar las EPAs segÃºn tipos de cultivo y permitir relaciÃ³n Nâ€“N.
DescripciÃ³n detallada:
â—	TipoCultivoWiki es un catÃ¡logo que NO es el mismo que los cultivos reales del sistema (es genÃ©rico: â€œCafÃ©â€, â€œTomateâ€, â€œMaÃ­zâ€).

â—	Una EPA puede asociarse a muchos TipoCultivoWiki, y un TipoCultivoWiki puede tener muchas EPAs.

â—	Se usa para filtros (ej: ver todas las enfermedades del cafÃ©).

â—	Operaciones:

â—‹	CRUD de TipoCultivoWiki.

â—‹	Asociar/desasociar EPA â†” TipoCultivoWiki.

Datos principales:
â—	TipoCultivoWiki

â—‹	id

â—‹	nombre

â—‹	descripcion

â—	EPA_TipoCultivoWiki

â—‹	epaId

â—‹	tipoCultivoWikiId

________________________________________
RF30 â€“ BÃºsqueda y filtros EPA
Tipo: Funcional
 PropÃ³sito: Encontrar rÃ¡pidamente fichas EPA relevantes.
DescripciÃ³n detallada:
â—	q: texto libre que busca sobre: nombre, descripcion, sintomas, tags.

â—	Filtros:

â—‹	tipoEpa (ENFERMEDAD, PLAGA, ARVENCE).

â—‹	tipoCultivoWikiId (filtra EPAs asociadas a ese cultivo).

â—‹	mes (1â€“12): filtra EPAs cuyo mesesProbables[mes] = true.

â—‹	temporada (ej: â€œlluviasâ€): filtra EPAs cuyas temporadas incluyan el valor.

â—‹	conFotos (bool): devuelve solo EPAs que tengan al menos una foto en fotosSintomas o fotosGenerales.

â—	Debe soportar paginaciÃ³n y orden (por nombre, tipo, mÃ¡s recientes, etc.).

Datos principales (entrada):
â—	q, tipoEpa, tipoCultivoWikiId, mes, temporada, conFotos, page, pageSize.

________________________________________
MÃ“DULO 7 Â· IoT (Sensores vinculados a Cultivo)
RF31 â€“ CRUD TipoSensor
Tipo: Funcional
 PropÃ³sito: Definir los tipos de sensores que se pueden usar (ej. humedad, temperatura).
DescripciÃ³n detallada:
â—	Cada TipoSensor define:

â—‹	Nombre descriptivo (ej. â€œSensor de humedad de sueloâ€).

â—‹	Unidad de medida (%, Â°C, pH, lux, etc.).

â—‹	Cantidad de decimales recomendados para mostrar y redondear lecturas (0..5).

â—‹	Imagen referencial del tipo de sensor (Ã­cono/foto).

â—	Operaciones: crear, editar, listar y soft delete (deletedAt).

â—	No se debe permitir borrar fÃ­sicamente si hay sensores asociados.

Datos principales:
â—	TipoSensor

â—‹	id

â—‹	nombre_tipo_sensor

â—‹	unidades_tipo_sensor

â—‹	decimales_tipo_sensor (0..5)

â—‹	imagen_tipo_sensor

â—‹	deletedAt

________________________________________
RF32 â€“ CRUD Sensor (por cultivo)
Tipo: Funcional
 PropÃ³sito: Configurar sensores fÃ­sicos o virtuales asociados a un cultivo.
DescripciÃ³n detallada:
â—	Cada Sensor estÃ¡ vinculado a un cultivoId (el cultivo que monitorea).

â—	Campos clave:

â—‹	Datos generales: nombre_sensor, tipo_sensor_id, activo.

â—‹	Protocolo de comunicaciÃ³n:

â– 	HTTP/HTTPS: lecturas llegan por peticiones HTTP.

â– 	WS: WebSocket.

â– 	MQTT: broker/topic.

â—‹	Config de protocolo (solo se llenan los campos que correspondan):

â– 	HTTP/HTTPS: endpoint_url.

â– 	MQTT: mqtt_broker, mqtt_port, mqtt_topic, mqtt_user, mqtt_password, mqtt_qos.

â—‹	Umbrales operativos:

â– 	valor_minimo_sensor, valor_maximo_sensor.

â—‹	Estado en runtime:

â– 	estado_conexion (ej: online | offline | unknown).

â– 	ultimo_valor.

â– 	ultima_medicion (timestamp de Ãºltima lectura).

â– 	last_seen_at (Ãºltima vez que se considerÃ³ â€œvivoâ€).

â—	Operaciones:

â—‹	Crear sensor.

â—‹	Editar configuraciÃ³n.

â—‹	Activar/desactivar (activo).

â—‹	Listar por cultivo / tipo / protocolo.

Datos principales:
â—	Sensor (todos los campos que ya definiste en los requerimientos originales).

________________________________________
RF33 â€“ Ingesta de lecturas
Tipo: Funcional
 PropÃ³sito: Recibir lecturas desde distintos protocolos y actualizar estado del sensor.
DescripciÃ³n detallada:
â—	Punto(s) de entrada para lecturas:

â—‹	HTTP/HTTPS: endpoint que recibe JSON.

â—‹	MQTT: suscripciÃ³n a topics y parseo del payload.

â—‹	WS: canal donde llegan data.

â—	Cada lectura genera un registro SensorLectura con:

â—‹	sensor_id, valor_sensor_lectura, fecha_sensor_lectura.

â—‹	raw_payload? (json/texto original).

â—‹	ingested_by (ej: http, mqtt, ws).

â—	Al almacenar la lectura:

â—‹	Actualizar Sensor.ultimo_valor.

â—‹	Actualizar Sensor.ultima_medicion.

â—‹	Actualizar Sensor.last_seen_at.

â—‹	Emitir evento realtime (WebSocket) para paneles de monitoreo.

Datos principales:
â—	SensorLectura{sensor_id, valor_sensor_lectura, fecha_sensor_lectura, raw_payload?, ingested_by}

â—	ActualizaciÃ³n de campos en Sensor.

________________________________________
RF34 â€“ TTL y estado de conexiÃ³n
Tipo: Funcional
 PropÃ³sito: Determinar si un sensor estÃ¡ â€œvivoâ€ o â€œdesconectadoâ€.
DescripciÃ³n detallada:
â—	ConfiguraciÃ³n global o por sensor: ttlMin (ej. 5â€“10 min).

â—	LÃ³gica:

â—‹	Si now - last_seen_at <= ttlMin â†’ estado_conexion = "online".

â—‹	Si now - last_seen_at > ttlMin â†’ estado_conexion = "offline".

â—	Esta evaluaciÃ³n puede hacerse:

â—‹	PeriÃ³dicamente con un job.

â—‹	O al momento de consultar el estado.

â—	Este estado se usa en paneles para mostrar sensores desconectados.

Datos principales:
â—	Sensor.last_seen_at, Sensor.estado_conexion.

â—	ParÃ¡metro de config: ttlMin.

________________________________________
MÃ“DULO 8 Â· ProducciÃ³n (Cosecha) & POS / Finanzas
RF35 â€“ Producto agro
Tipo: Funcional
 PropÃ³sito: CatÃ¡logo de productos que se venden (ej. â€œTomate frescoâ€, â€œCafÃ© pergaminoâ€).
DescripciÃ³n detallada:
â—	Cada ProductoAgro representa algo vendible; la unidad base SIEMPRE es kg (internamente).

â—	Se puede usar la misma entidad para diferentes presentaciones en POS (1kg, 500g, etc.), pero la base es kg.

â—	InformaciÃ³n bÃ¡sica:

â—‹	nombre.

â—‹	unidadBase = "kg".

â—‹	descripcion.

â—	Opcional: categorÃ­a de producto, tipo, etc.

Datos principales:
â—	ProductoAgro{id, nombre, unidadBase="kg", descripcion}.

________________________________________
RF36 â€“ Lote de producciÃ³n
Tipo: Funcional
 PropÃ³sito: Representar la cosecha resultante de un cultivo como stock disponible.
DescripciÃ³n detallada:
â—	Se crea normalmente al registrar una actividad de cosecha (RF23).

â—	Campos clave:

â—‹	productoAgroId: quÃ© producto se genera (ej. tomate, cafÃ©).

â—‹	cultivoId: cultivo de origen.

â—‹	loteId | subLoteId: dÃ³nde se cosechÃ³ (opcional pero Ãºtil).

â—‹	actividadCosechaId: referencia a la actividad que lo originÃ³.

â—‹	cantidadKg: cantidad cosechada.

â—‹	costoUnitarioKg: costo promedio por kg (calculado a partir de costos del cultivo o ingresado manual de momento).

â—‹	costoTotal = cantidadKg * costoUnitarioKg.

â—‹	precioSugeridoKg: precio de venta sugerido.

â—	El stock de este lote se reducirÃ¡ con las ventas (RF39).

Datos principales:
â—	LoteProduccion (campos anteriores).

________________________________________
RF37 â€“ Movimientos de producciÃ³n
Tipo: Funcional
 PropÃ³sito: Mantener historial de entradas y salidas de stock de producciÃ³n.
DescripciÃ³n detallada:
â—	Tipos de movimiento:

â—‹	INGRESO_COSECHA (entrada inicial).

â—‹	VENTA (salida por venta).

â—‹	AJUSTE_+ / AJUSTE_- (correcciones).

â—‹	TRASLADO (entre almacenes o ubicaciones si lo implementas).

â—	Cada movimiento:

â—‹	loteProduccionId.

â—‹	tipo.

â—‹	cantidadKg.

â—‹	costoUnitarioKg (para mantener costos).

â—‹	costoTotal.

â—‹	ventaId? si estÃ¡ vinculado a una venta.

â—‹	descripcion.

â—‹	usuarioId ejecutor.

â—‹	createdAt.

â—	El stock disponible de un LoteProduccion se calcula por suma de movimientos (positivo/negativo).

________________________________________
RF38 â€“ Cliente
Tipo: Funcional
 PropÃ³sito: Gestionar clientes del POS.
DescripciÃ³n detallada:
â—	Cliente puede ser:

â—‹	Identificado (con cÃ©dula/NIT).

â—‹	â€œMostradorâ€ para ventas rÃ¡pidas sin datos especÃ­ficos.

â—	Se guarda informaciÃ³n bÃ¡sica de contacto:

â—‹	nombre, identificacion, telefono, email, direccion, notas.

â—	Se usa en ventas e informes (RF41).

________________________________________
RF39 â€“ Venta POS
Tipo: Funcional
 PropÃ³sito: Gestionar el proceso completo de venta de productos.
DescripciÃ³n detallada:
â—	Venta: encabezado con informaciÃ³n general:

â—‹	fecha.

â—‹	clienteId (cliente normal o â€œmostradorâ€).

â—‹	subtotal, impuestos, descuento, total.

â—‹	estado (registrada, pagada, anulada, etc.).

â—‹	usuarioId (vendedor).

â—	VentaDetalle: lÃ­neas de la venta:

â—‹	productoAgroId.

â—‹	loteProduccionId? (si se controla por lote).

â—‹	cultivoId (para trazabilidad).

â—‹	cantidadKg.

â—‹	precioUnitarioKg.

â—‹	precioTotal.

â—‹	costoUnitarioKg y costoTotal para cÃ¡lculo de margen.

â—	Pago: uno o varios pagos por venta (efectivo, transferencia, etc.).

â—	Factura: datos fiscales (nÃºmero, prefijo, QR, PDF).

â—	LogÃ­stica de stock:

â—‹	Al registrar una venta, se crean MovimientoProduccion de tipo VENTA por cada detalle.

â—‹	Se descuenta cantidadKg del lote correspondiente.

________________________________________
RF40 â€“ AnulaciÃ³n de ventas
Tipo: Funcional
 PropÃ³sito: Revertir una venta y su impacto en stock.
DescripciÃ³n detallada:
â—	Al anular una venta:

â—‹	Cambiar Venta.estado = "anulada".

â—‹	Generar movimientos inversos de stock:

â– 	Por cada VentaDetalle, un MovimientoProduccion que sume de nuevo cantidadKg al lote.

â—‹	Registrar usuarioId que hizo la anulaciÃ³n y fecha.

â—	Debe impedirse anular ventas ya anuladas (idempotente).

________________________________________
MÃ“DULO 9 Â· Reportes & Rentabilidad (Finanzas)
RF41 â€“ Reporte de ventas
Tipo: Funcional
 PropÃ³sito: Analizar ventas por distintos criterios.
DescripciÃ³n detallada:
â—	Filtros:

â—‹	from, to (rango de fechas).

â—‹	productoAgroId.

â—‹	clienteId.

â—‹	cultivoId.

â—	Resultados:

â—‹	Listado de ventas con totales.

â—‹	Totales globales: subtotal, impuestos, descuento, total.

â—	Funcionalidades:

â—‹	Agrupar por cliente, producto o cultivo (opcional).

â—‹	Exportar a CSV/XLS (puede reutilizar lÃ³gica de exportes generales).

________________________________________
RF42 â€“ Precios histÃ³ricos (precio/kg)
Tipo: Funcional
 PropÃ³sito: Ver cÃ³mo han variado los precios por kg.
DescripciÃ³n detallada:
â—	Tomar datos de VentaDetalle y construir serie temporal.

â—	Filtros:

â—‹	productoAgroId, cultivoId, from, to.

â—‹	agregacion: periodo (dÃ­a, semana, mes).

â—	Para cada intervalo:

â—‹	Calcular precio promedio por kg (sum precioTotal / sum cantidadKg).

________________________________________
RF43 â€“ Rentabilidad por cultivo/lote/subLote
Tipo: Funcional
 PropÃ³sito: Saber si los cultivos estÃ¡n dejando plata o no ğŸ’¸.
DescripciÃ³n detallada:
â—	Rentabilidad = Ingresos - COGS - costosActividad.

â—	Componentes:

â—‹	Ingresos: suma de ventas asociadas al cultivo (por VentaDetalle.cultivoId).

â—‹	COGS: costo de los kg vendidos (costoUnitarioKg * cantidadKg).

â—‹	costosActividad:

â– 	Mano de obra (RF17).

â– 	Servicios (RF18).

â– 	Insumos consumidos (RF20 / RF24â€“27).

â—	Filtros:

â—‹	from, to.

â—‹	Entidad: por cultivo, lote, subLote.

â—	Salida: KPIs (margen, margen %, costo por kg, etc.) + posibilidad de grÃ¡ficos.

________________________________________
MÃ“DULO 10 Â· Reportes IoT (Agregaciones y KPIs)
RF44 â€“ Resumen por sensor
Tipo: Funcional
 PropÃ³sito: Resumir lecturas de un sensor en series agregadas.
DescripciÃ³n detallada:
â—	Dado un sensorId, from, to, granularity:

â—‹	Agrupar lecturas en intervalos (ej. cada 5 min, cada hora, etc.).

â—‹	Para cada intervalo calcular:

â– 	avg, min, max, count.

â—	Se usa para grÃ¡ficos histÃ³ricos y anÃ¡lisis.

________________________________________
RF45 â€“ Resumen por cultivo (multi-sensor)
Tipo: Funcional
 PropÃ³sito: Ver el comportamiento general de un cultivo considerando todos sus sensores.
DescripciÃ³n detallada:
â—	A partir de todos los sensores de un cultivoId:

â—‹	Agrupar lecturas de todos ellos en intervalos.

â—‹	Para cada intervalo:

â– 	avg, min, max, count de todas las lecturas.

â– 	sensoresActivos = cantidad de sensores que reportaron en ese intervalo.

________________________________________
RF46 â€“ Resumen por tipo de sensor
Tipo: Funcional
 PropÃ³sito: Analizar comportamiento por tipo de mediciÃ³n (ej. todos los sensores de humedad).
DescripciÃ³n detallada:
â—	Filtros: tipoSensorId, from, to, granularity.

â—	Misma lÃ³gica de agregados que RF44, pero agrupando sensores por tipo.

________________________________________
RF47 â€“ % fuera de rango
Tipo: Funcional
 PropÃ³sito: Saber quÃ© tan seguido un sensor (o cultivo) estÃ¡ fuera de umbral.
DescripciÃ³n detallada:
â—	Dado un sensorId o cultivoId + rango de fechas:

â—‹	Calcular:

â– 	total de lecturas.

â– 	fueraRango: lecturas con valor < valor_minimo_sensor o > valor_maximo_sensor.

â– 	porcentaje = fueraRango / total * 100.

â—	Para cultivoId, se considera el total de lecturas de todos los sensores del cultivo.

________________________________________
RF48 â€“ Uptime del sensor
Tipo: Funcional
 PropÃ³sito: Medir disponibilidad de los sensores IoT.
DescripciÃ³n detallada:
â—	Con sensorId, from, to, ttlMin:

â—‹	Dividir el periodo en minutos.

â—‹	Considerar â€œconectadoâ€ si en una ventana el sensor tiene last_seen_at con diferencia â‰¤ ttlMin.

â—‹	Calcular:

â– 	minutosConectado.

â– 	minutosTotales.

â– 	uptimePercent = minutosConectado / minutosTotales * 100.

________________________________________
RF49 â€“ Ãšltimo valor + sparkline
Tipo: Funcional
 PropÃ³sito: Mostrar tarjetas compactas de sensores.
DescripciÃ³n detallada:
â—	Para un sensorId y una ventana (ej. Ãºltimas 24h):

â—‹	Obtener:

â– 	lastValue, lastAt.

â– 	Una pequeÃ±a serie {ts, v} con las Ãºltimas N lecturas o agregados.

â—	Se usa en dashboards tipo â€œtarjetaâ€.

________________________________________
RF50 â€“ Comparativa de sensores
Tipo: Funcional
 PropÃ³sito: Ranking de sensores por mÃ©tricas.
DescripciÃ³n detallada:
â—	Filtros:

â—‹	tipoSensorId o cultivoId.

â—‹	from, to.

â—‹	metric (avg, max, min).

â—‹	limit.

â—	Calcular para cada sensor su mÃ©trica agregada en el periodo y ordenarlos.

________________________________________
RF51 â€“ ExportaciÃ³n CSV/XLS (IoT)
Tipo: Funcional
 PropÃ³sito: Descargar datos agregados y KPIs IoT.
DescripciÃ³n detallada:
â—	Permitir exportar resultados de RF44â€“RF50 a CSV o XLS:

â—‹	Series de tiempo.

â—‹	KPIs de uptime, fuera de rango, comparativas.

â—	Entrada: mismos filtros que el reporte correspondiente + formato (CSV/XLS).

â—	Salida: archivo descargable.

________________________________________
MÃ“DULO 11 Â· Reportes Historial del Cultivo
RF52 â€“ Resumen histÃ³rico del cultivo
Tipo: Funcional
 PropÃ³sito: Tener una vista global del esfuerzo y costo de un cultivo.
DescripciÃ³n detallada:
â—	Para un cultivoId y rango:

â—‹	#actividades.

â—‹	horas totales (suma de horasActividad o por responsables).

â—‹	insumos distintos (cuÃ¡ntos diferentes insumos se usaron).

â—‹	cantidad total de insumos (en g/cmÂ³).

â—‹	costos separados: mano de obra, servicios, insumos.

â—	Se utiliza info de: Actividad, ActividadResponsable, ActividadServicio, consumos de insumo y movimientos.

________________________________________
RF53 â€“ Conteo de actividades por tipo/subtipo
Tipo: Funcional
 PropÃ³sito: Entender quÃ© tipo de labores se realizan mÃ¡s.
DescripciÃ³n detallada:
â—	Para un cultivo y periodo:

â—‹	Contar cuÃ¡ntas actividades hay por tipo y por subtipo.

â—	Puede representarse como grÃ¡fico de barras/pastel.

________________________________________
RF54 â€“ Horas invertidas por periodo
Tipo: Funcional
 PropÃ³sito: Ver la carga de trabajo en el tiempo.
DescripciÃ³n detallada:
â—	Agrupar horas invertidas por dÃ­a | semana | mes (segÃºn granularity) para un cultivo.

â—	horas = suma(horasActividad) o suma por responsables si las manejas a ese nivel.

________________________________________
RF55 â€“ Horas por responsable
Tipo: Funcional
 PropÃ³sito: Saber quÃ© usuarios han trabajado mÃ¡s en un cultivo.
DescripciÃ³n detallada:
â—	Para un cultivo y periodo:

â—‹	Agrupar por usuarioId y calcular:

â– 	horas totales.

â– 	costo asociado (horas * precioHora).

â—	Devolver una lista ordenada tipo ranking.

________________________________________
RF56 â€“ Insumos consumidos (detalle y totales)
Tipo: Funcional
 PropÃ³sito: Analizar consumo de insumos en el cultivo.
DescripciÃ³n detallada:
â—	Por cultivo y periodo, para cada insumo:

â—‹	cantidadUsoTotal (en unidades de uso g/cmÂ³).

â—‹	costoPromUso (precio promedio).

â—‹	costoTotal (suma costo).

â—‹	actividadesUsado (# actividades donde se utilizÃ³).

________________________________________
RF57 â€“ Consumo de insumos por periodo
Tipo: Funcional
 PropÃ³sito: Ver cÃ³mo varÃ­a el uso de insumos en el tiempo.
DescripciÃ³n detallada:
â—	Similar a RF54 pero con insumos:

â—‹	Agrupar por periodo (1d|1w|1m).

â—‹	Para cada intervalo:

â– 	cantidadUsoTotal.

â– 	costoTotal.

________________________________________
RF58 â€“ Detalle de actividades con costos
Tipo: Funcional
 PropÃ³sito: Tener una tabla detallada para auditorÃ­a y anÃ¡lisis fino.
DescripciÃ³n detallada:
â—	Listar actividades del cultivo en un periodo con:

â—‹	actividadId, fecha, tipo, subtipo.

â—‹	horas.

â—‹	costoMO.

â—‹	costoServicios.

â—‹	costoInsumos.

â—‹	costoTotal.

â—	Base para descargar a Excel y hacer mÃ¡s anÃ¡lisis.

________________________________________
RF59 â€“ Top insumos por costo/cantidad
Tipo: Funcional
 PropÃ³sito: Identificar los insumos mÃ¡s crÃ­ticos o mÃ¡s costosos.
DescripciÃ³n detallada:
â—	Para cultivo y periodo:

â—‹	Ordenar insumos por:

â– 	cantidadUsoTotal (orden = cantidad).

â– 	o costoTotal (orden = costo).

â—‹	Aplicar limit (ej. top 10).

________________________________________
RF60 â€“ ExportaciÃ³n CSV/XLS (historial cultivo)
Tipo: Funcional
 PropÃ³sito: Permitir que el usuario saque toda la info del cultivo a archivos.
DescripciÃ³n detallada:
â—	Entradas: cultivoId, from, to, secciones (quÃ© incluir: resumen, actividades, insumos, horas, etc.).

â—	Generar uno o varios CSV/XLS con:

â—‹	Resumen (RF52).

â—‹	Listado de actividades (RF58).

â—‹	Insumos (RF56).

â—‹	Horas/responsables (RF55).

________________________________________
RF61 â€“ ValidaciÃ³n de coherencia
Tipo: Funcional
 PropÃ³sito: Revisar que inventario y actividades coincidan.
DescripciÃ³n detallada:
â—	Para cultivoId y periodo:

â—‹	Comparar suma de consumos registrados en actividades con:

â– 	Movimientos de tipo CONSUMO asociados al cultivo/actividades de ese cultivo.

â—‹	Si hay diferencias, listar:

â– 	Insumo, diferencia en cantidad/costo, actividades o movimientos implicados.

â—	Resultado: { ok: boolean, diferencias[] }.

________________________________________
MÃ“DULO 12 Â· Transversales
RF62 â€“ Responsable de acciÃ³n (actor)
Tipo: Funcional
 PropÃ³sito: Tener siempre quiÃ©n hizo quÃ©.
DescripciÃ³n detallada:
â—	Toda operaciÃ³n que cambie el estado del sistema debe guardar el usuarioId ejecutor.

â—	Ejemplos:

â—‹	creadoPorUsuarioId en Actividad, EPA, TipoSensor, Insumo, etc.

â—‹	usuarioId en MovimientoInsumo, MovimientoProduccion, Venta, Pago, etc.

â—	Se usa para auditorÃ­a y trazabilidad.

________________________________________
RF63 â€“ Realtime e invalidaciÃ³n de cachÃ©
Tipo: Funcional
 PropÃ³sito: Mantener sincronizados frontends y cachÃ©s.
DescripciÃ³n detallada:
â—	Al hacer cambios crÃ­ticos:

â—‹	Emitir eventos WebSocket por canal de mÃ³dulo (ej. iot/sensores, inventario/insumos).

â—‹	Borrar/invalidate la cachÃ© de listados relacionados (ej. lista de usuarios, lista de sensores).

â—	Ejemplos:

â—‹	Al crear actividad â†’ invalidar cache de actividades y emitir evento para dashboards.

â—‹	Al cambiar permisos â†’ invalidar cachÃ© de permisos efectivos (RF08).

________________________________________
RF64 â€“ AuditorÃ­a y soft delete
Tipo: Funcional
 PropÃ³sito: Cumplir buenas prÃ¡cticas de registro de cambios y no perder historial.
DescripciÃ³n detallada:
â—	Entidades maestras (usuarios, roles, insumos, EPA, etc.) deben tener:

â—‹	createdAt, updatedAt, deletedAt.

â—‹	deletedAt â‰  null implica â€œborrado lÃ³gicoâ€ â†’ no aparece en listados normales.

â—	Entidades de historial (movimientos, lecturas, ventas) en general no se borran, solo se anulan (ej. ventas con estado anulada).

________________________________________
RF65 â€“ Filtros y paginaciÃ³n
Tipo: Funcional
 PropÃ³sito: Mantener un estÃ¡ndar para todos los listados.
DescripciÃ³n detallada:
â—	Todos los listados deben soportar, como mÃ­nimo:

â—‹	BÃºsqueda q por texto.

â—‹	Filtros especÃ­ficos de la entidad (estado, tipo, fechas, etc.).

â—‹	from, to en los que tenga sentido.

â—‹	Orden: orderBy, orderDir.

â—‹	PaginaciÃ³n: page, limit, total.

â—	Esto aplica para: usuarios, lotes, sublotes, cultivos, actividades, insumos, EPA, sensores, ventas, etc.

MÃ“DULO 0 Â· GestiÃ³n de Usuarios (versiÃ³n final)
RF66 â€“ Listado y bÃºsqueda de usuarios
Tipo: Funcional
 PropÃ³sito: Ver y buscar usuarios del sistema.
DescripciÃ³n detallada:
â—	Pantalla para listar todos los usuarios con columnas bÃ¡sicas:

â—‹	nombre, apellido, identificacion, idFicha, telefono,
 correo, rol, estado, lastLoginAt, avatar (pequeÃ±o).

â—	Filtros / bÃºsqueda:

â—‹	q â†’ busca por nombre, apellido, identificacion, correo, idFicha.

â—‹	rolId.

â—‹	estado (activo | inactivo | pendiente_verificacion | eliminado).

â—	PaginaciÃ³n y orden:

â—‹	page, limit, orderBy (ej. nombre, createdAt), orderDir (asc|desc).

â—	RelaciÃ³n con otros RF: usa la convenciÃ³n general de filtros/paginaciÃ³n de RF65.

________________________________________
RF67 â€“ CreaciÃ³n manual de usuario (por admin)
Tipo: Funcional
 PropÃ³sito: Permitir que un administrador cree usuarios desde el panel (sin usar el formulario pÃºblico).
DescripciÃ³n detallada:
â—	Desde el panel, un admin puede crear un usuario ingresando:

â—‹	nombre, apellido, identificacion, idFicha, telefono,
 correo, rolId, estado, avatarUrl (opcional).

â—	Puede:

â—‹	Definir directamente el rolId (no necesariamente Invitado).

â—‹	Elegir si emailVerifiedAt queda null o marcado como verificado.

â—	ContraseÃ±a:

â—‹	Se genera automÃ¡ticamente (token aleatorio) y se envÃ­a por email,
 o se obliga al usuario a usar el flujo de â€œolvidÃ© mi contraseÃ±aâ€ para definirla.

â—‹	El admin no ve ni define la clave final, solo dispara el flujo.

â—	RelaciÃ³n con otros RF: se apoya en RF01 (registro) y RF05 (recuperaciÃ³n).

________________________________________
RF68 â€“ EdiciÃ³n de datos del usuario
Tipo: Funcional
 PropÃ³sito: Actualizar datos de perfil desde el mÃ³dulo de usuarios (por admin).
DescripciÃ³n detallada:
â—	Desde el detalle de usuario, un admin puede editar:

â—‹	nombre, apellido.

â—‹	idFicha.

â—‹	telefono.

â—‹	correo (validando unicidad).

â—‹	estado (activo/inactivo, ver RF70).

â—‹	avatarUrl (subir/cambiar imagen de perfil).

â—	Reglas:

â—‹	identificacion y correo deben seguir siendo Ãºnicos.

â—‹	Cambiar correo puede, segÃºn polÃ­tica:

â– 	resetear emailVerifiedAt a null, y

â– 	obligar a nueva verificaciÃ³n de correo.

â—	Importante:

â—‹	El admin no cambia la contraseÃ±a aquÃ­ (eso se cubre en RF71 y RF05).

________________________________________
RF69 â€“ Cambio de rol del usuario (desde gestiÃ³n de usuarios)
Tipo: Funcional
 PropÃ³sito: Cambiar el rol principal de un usuario de forma controlada.
DescripciÃ³n detallada:
â—	En el listado o detalle de usuarios, un admin puede cambiar rolId.

â—	Reglas:

â—‹	Solo usuarios con permisos (ej. usuarios.roles.editar) pueden hacerlo.

â—‹	Se puede prevenir que un admin se quite a sÃ­ mismo el Ãºltimo rol con permisos de administraciÃ³n (para no quedarse sin admins).

â—	Efectos:

â—‹	Al cambiar rolId, se debe invalidar la cachÃ© de permisos efectivos del usuario (RF08).

â—‹	Opcional: enviar notificaciÃ³n en tiempo real al usuario afectado (WS) (RF63).

________________________________________
RF70 â€“ Activar / inactivar / bloquear usuario
Tipo: Funcional
 PropÃ³sito: Controlar quiÃ©n puede iniciar sesiÃ³n y operar en el sistema.
DescripciÃ³n detallada:
â—	Estados manejados en Usuario.estado:

â—‹	activo: puede loguearse y usar el sistema.

â—‹	inactivo: no puede loguearse (login debe fallar siempre).

â—‹	pendiente_verificacion: creado pero sin verificar correo.

â—‹	eliminado (opcional): soft delete para no mostrarlo en listados normales.

â—	Desde GestiÃ³n de Usuarios, un admin puede:

â—‹	Pasar activo â†’ inactivo (deshabilitar cuenta).

â—‹	inactivo â†’ activo (restaurar).

â—	Al inactivar un usuario:

â—‹	Se recomienda invalidar todas sus sesiones activas (borrar tokens de Redis/session store).

â—‹	Cualquier request futura con auth_token de ese usuario debe ser rechazada.

________________________________________
RF71 â€“ Cambio y recuperaciÃ³n de contraseÃ±a (por el usuario)
Nota: AquÃ­ ya no hay â€œadmin pone claveâ€.
 Solo el usuario define su contraseÃ±a, ya sea desde su perfil o usando â€œolvidÃ© mi contraseÃ±aâ€.
Tipo: Funcional
 PropÃ³sito: Permitir al usuario cambiar o recuperar su propia contraseÃ±a de forma segura.
DescripciÃ³n detallada:
A) Cambio de contraseÃ±a desde el perfil (usuario autenticado)
â—	Desde la pantalla â€œMi perfilâ€, el usuario puede cambiar su clave:

â—‹	Inputs: oldPassword, newPassword, confirmNewPassword.

â—	Reglas:

â—‹	Validar que oldPassword coincide con passwordHash actual (bcrypt.compare).

â—‹	Validar reglas de seguridad (longitud mÃ­nima, etc.).

â—‹	Guardar newPassword encriptada (bcrypt).

â—‹	Invalidar todas las sesiones activas del usuario excepto la actual (opcional) o todas, obligando re-login.

B) RecuperaciÃ³n de contraseÃ±a (â€œolvidÃ© mi contraseÃ±aâ€)
â—	Flujo pÃºblico ya descrito en RF05:

â—‹	El usuario ingresa su correo.

â—‹	Se genera un EmailCode tipo reset y se envÃ­a por correo.

â—‹	El usuario pone code + nuevaContraseÃ±a.

â—	Reglas (RF05):

â—‹	CÃ³digo vÃ¡lido, no expirado, no usado.

â—‹	Se actualiza passwordHash y se marca EmailCode.usedAt.

â—‹	Se invalidan sesiones activas del usuario.

Admin y contraseÃ±as:
â—	El admin NO establece contraseÃ±as manualmente.

â—	Como mucho, puede desde el panel apretar â€œEnviar enlace de recuperaciÃ³nâ€, que llama internamente al flujo de RF05 para ese correo.

________________________________________
RF72 â€“ Perfil del usuario (self-service)
Tipo: Funcional
 PropÃ³sito: Que cada usuario gestione parte de su informaciÃ³n y su contraseÃ±a.
DescripciÃ³n detallada:
â—	Desde el frontend, un usuario autenticado ve la pantalla â€œMi perfilâ€ con:

â—‹	Datos visibles: nombre, apellido, correo, telefono, idFicha, rol, estado (solo lectura), avatar.

â—	Puede editar:

â—‹	telefono.

â—‹	idFicha.

â—‹	Opcionalmente nombre y apellido (segÃºn polÃ­tica).

â—‹	avatarUrl â†’ subir o cambiar su foto de perfil.

â—	No puede:

â—‹	Cambiar su rolId.

â—‹	Cambiar estado.

â—	Desde esta misma pantalla se expone el botÃ³n â€œCambiar contraseÃ±aâ€, que usa el flujo de RF71 (A).




